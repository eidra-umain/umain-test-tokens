name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build:
    name: build UmainDesignToken
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app
      
      - name: Build package
        run: swift build
      
      - name: Validate token files
        run: |
          echo "üîç Validating token file structure..."
          EXPECTED_FILES=("CornerRadius.swift" "SemanticColors.swift" "Palette.swift" "Spacing.swift" "TypographySizes.swift" "IconSize.swift" "ImageSize.swift" "SpatialSystem.swift" "EffectsElevation.swift" "Gradientstops.swift")
          TOKENS_DIR="Sources/UmainDesignToken/Tokens"
          MISSING=0

          for file in "${EXPECTED_FILES[@]}"; do
            if [ ! -f "$TOKENS_DIR/$file" ]; then
              echo "‚ùå Missing: $TOKENS_DIR/$file"
              MISSING=$((MISSING + 1))
            else
              echo "‚úÖ Found: $file"
            fi
          done

          # Verify generated file markers
          UNMARKED=0
          for file in "$TOKENS_DIR"/*.swift; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "TokenShowcaseView.swift" ]; then
              if ! grep -q "Generated by" "$file" 2>/dev/null; then
                echo "‚ö†Ô∏è  No generation marker in: $(basename "$file")"
                UNMARKED=$((UNMARKED + 1))
              fi
            fi
          done

          TOTAL_FILES=$(find "$TOKENS_DIR" -name "*.swift" -type f | wc -l | tr -d ' ')
          echo ""
          echo "üìä Token files: $TOTAL_FILES total, $MISSING missing, $UNMARKED unmarked"

          if [ "$MISSING" -gt "0" ]; then
            echo "::error::$MISSING expected token file(s) are missing"
            exit 1
          fi

          echo "‚úÖ All expected token files present"
      
      - name: Test package
        run: |
          if [ -d "Tests" ] && [ "$(ls -A Tests)" ]; then
            swift test
          else
            echo "‚ö†Ô∏è No tests found, skipping test step"
          fi

